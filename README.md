# è‹±å›½äººå£è€é¾„åŒ–è¶‹åŠ¿é¢„æµ‹

è¿™æ˜¯ä¸€ä¸ªåŸºäºè‹±å›½å›½å®¶ç»Ÿè®¡å±€ï¼ˆONSï¼‰æ•°æ®çš„äººå£è€é¾„åŒ–è¶‹åŠ¿é¢„æµ‹å’ŒåŒºåŸŸå·®å¼‚åˆ†æé¡¹ç›®ã€‚é¡¹ç›®é‡‡ç”¨å¤šç§æ—¶é—´åºåˆ—é¢„æµ‹æ¨¡å‹ï¼ˆProphet å’Œ ARIMAï¼‰å¯¹è‹±å›½å„åœ°åŒº 65 å²åŠä»¥ä¸Šäººå£æ¯”ä¾‹è¿›è¡Œé•¿æœŸé¢„æµ‹ï¼Œå¹¶é€šè¿‡èšç±»åˆ†æè¯†åˆ«åŒºåŸŸè€é¾„åŒ–ç‰¹å¾ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | æè¿° | é€‚ç”¨åœºæ™¯ |
|-----|------|--------|
| **[README.md](./README.md)** | é¡¹ç›®å®Œæ•´è¯´æ˜æ–‡æ¡£ | äº†è§£é¡¹ç›®çš„æŠ€æœ¯ç»†èŠ‚å’Œå®ç° |
| **[PROJECT_SUMMARY_FOR_RESUME.md](./PROJECT_SUMMARY_FOR_RESUME.md)** | ç®€å†ç‰ˆæœ¬æ€»ç»“ | ä¸€èˆ¬æ€§çš„ç®€å†æˆ–é¢è¯• |
| **[PROJECT_SUMMARY_COMPANY_OPTIMIZED.md](./PROJECT_SUMMARY_COMPANY_OPTIMIZED.md)** | èŒä½ä¼˜åŒ–ç‰ˆ | é’ˆå¯¹AI/å¤§æ•°æ®å…¬å¸é¢è¯• |

---

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

- **ç ”ç©¶å¯¹è±¡**ï¼šè‹±å›½å„åœ°åŒºï¼ˆè‹±æ ¼å…°ã€å¨å°”å£«ã€è‹æ ¼å…°ï¼‰65 å²åŠä»¥ä¸Šäººå£çš„æ¯”ä¾‹å˜åŒ–
- **é¢„æµ‹æ—¶é—´è·¨åº¦**ï¼š2020-2070 å¹´
- **é¢„æµ‹æ–¹æ³•**ï¼šProphet æ—¶é—´åºåˆ—é¢„æµ‹ã€ARIMA æ¨¡å‹ã€KMeans èšç±»åˆ†æ
- **æ•°æ®æ¥æº**ï¼šè‹±å›½å›½å®¶ç»Ÿè®¡å±€ï¼ˆONSï¼‰å®˜æ–¹æ•°æ®

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. **æ•°æ®é¢„å¤„ç†** (`src/preprocess*.py`)
- ä» Excel/XLS æ ¼å¼çš„ ONS åŸå§‹æ•°æ®ä¸­æå–äººå£æ•°æ®
- æŒ‰å¹´é¾„ã€å¹´ä»½ã€åœ°åŒºç­‰ç»´åº¦è¿›è¡Œæ•°æ®æ¸…æ´—å’Œæ•´å½¢
- æ”¯æŒè‹±å›½å„åœ°åŒºçš„åˆ†åˆ«å¤„ç†ï¼šè‹±æ ¼å…°ã€å¨å°”å£«ã€è‹æ ¼å…°ã€è‹±å›½æ•´ä½“
- è¾“å‡ºé•¿æ ¼å¼ CSV ä¾¿äºåç»­åˆ†æ

### 2. **æ•°æ®èåˆ** (`src/merge_projection_data.py`)
- å°†å†å²è§‚æµ‹æ•°æ®å’Œé¢„æµ‹æ•°æ®è¿›è¡Œåˆå¹¶
- è®¡ç®—å„åœ°åŒºçš„è€é¾„åŒ–æ¯”ä¾‹ï¼ˆ65+äººå£å æ¯”ï¼‰
- ç”Ÿæˆç»Ÿä¸€çš„æ•°æ®é›†ç”¨äºå»ºæ¨¡

### 3. **æ—¶é—´åºåˆ—é¢„æµ‹** 
- **Prophet æ¨¡å‹** (`src/model_prophet.py`)
  - æ”¯æŒé€»è¾‘å¢é•¿çº¦æŸ
  - è‡ªé€‚åº”å˜åŒ–ç‚¹æ£€æµ‹
  - æ»šåŠ¨å¹³å‡å¹³æ»‘å¤„ç†
  
- **ARIMA æ¨¡å‹** (`src/model_arima.py`)
  - è‡ªåŠ¨ ARIMA å‚æ•°é€‰æ‹©
  - ä¸ Prophet ç»“æœå¯¹æ¯”è¯„ä¼°
  - æ”¯æŒå¤šåœ°åŒºå¯¹æ¯”åˆ†æ

### 4. **èšç±»åˆ†æ** (`src/cluster_analysis.py`)
- å¯¹å„åœ°åŒºè€é¾„åŒ–è¶‹åŠ¿è¿›è¡Œ KMeans èšç±»ï¼ˆé»˜è®¤ 3 ç±»ï¼‰
- æ ‡å‡†åŒ–é¢„å¤„ç†ç¡®ä¿å…¬å¹³å¯¹æ¯”
- å¯è§†åŒ–å±•ç¤ºå„åœ°åŒºèšç±»ç»“æœ

### 5. **å¯è§†åŒ–** (`src/plot_*.py`)
- 65+ äººå£æ¯”ä¾‹è¶‹åŠ¿å›¾
- å†å²æ•°æ® + é¢„æµ‹æ•°æ®å¯¹æ¯”
- å¤šæ¨¡å‹é¢„æµ‹ç»“æœå¯¹æ¯”ï¼ˆProphet vs ARIMAï¼‰
- åœ°åŒºèšç±»å¯è§†åŒ–
- æ—¶é—´åºåˆ—åˆ†è§£å¯è§†åŒ–

## ğŸ—‚ï¸ é¡¹ç›®ç»“æ„

```
forecasting-uk-ageing-trends/
â”œâ”€â”€ main.py                          # é¡¹ç›®ä¸»å…¥å£ï¼Œå®šä¹‰æ‰§è¡Œæµç¨‹
â”œâ”€â”€ requirements.txt                 # Python ä¾èµ–åŒ…åˆ—è¡¨
â”œâ”€â”€ README.md                        # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”‚
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ raw/                         # åŸå§‹æ•°æ®ï¼ˆONS Excel/XLS æ–‡ä»¶ï¼‰
â”‚   â”‚   â”œâ”€â”€ mid_year_population_estimates_uk.xlsx
â”‚   â”‚   â”œâ”€â”€ SNPP18dt2.xlsx
â”‚   â”‚   â”œâ”€â”€ enppvsumpop20.xls        # è‹±æ ¼å…°æŠ•å½±æ•°æ®
â”‚   â”‚   â”œâ”€â”€ scppvsumpop20.xls        # è‹æ ¼å…°æŠ•å½±æ•°æ®
â”‚   â”‚   â”œâ”€â”€ wappvsumpop20.xls        # å¨å°”å£«æŠ•å½±æ•°æ®
â”‚   â”‚   â””â”€â”€ ukppvsumpop20.xls        # è‹±å›½æ•´ä½“æŠ•å½±æ•°æ®
â”‚   â””â”€â”€ processed/                   # å¤„ç†åçš„æ•°æ®
â”‚       â”œâ”€â”€ cleaned_population_long.csv          # æ¸…æ´—åçš„å†å²äººå£æ•°æ®
â”‚       â”œâ”€â”€ projected_population_long.csv        # æŠ•å½±äººå£æ•°æ®
â”‚       â”œâ”€â”€ england_clean.csv / scotland_clean.csv / wales_clean.csv
â”‚       â”œâ”€â”€ uk_population_projection_all.csv     # åˆå¹¶æ•°æ®
â”‚       â”œâ”€â”€ ageing_ratio_per_region.csv          # å„åœ°åŒºè€é¾„åŒ–æ¯”ä¾‹
â”‚       â””â”€â”€ ageing_cluster_input.csv             # èšç±»åˆ†æè¾“å…¥æ•°æ®
â”‚
â”œâ”€â”€ output/                          # è¾“å‡ºç»“æœ
â”‚   â”œâ”€â”€ *.png                        # å„ç±»å¯è§†åŒ–å›¾è¡¨
â”‚   â”œâ”€â”€ *.csv                        # é¢„æµ‹ç»“æœæ•°æ®
â”‚   â””â”€â”€ multi_compare/               # å¤šæ¨¡å‹å¯¹æ¯”ç»“æœ
â”‚
â””â”€â”€ src/                             # æºä»£ç 
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ preprocess.py                # è‹±å›½æ•´ä½“æ•°æ®æ¸…æ´—
    â”œâ”€â”€ preprocess_england.py        # è‹±æ ¼å…°æ•°æ®å¤„ç†
    â”œâ”€â”€ preprocess_scotland.py       # è‹æ ¼å…°æ•°æ®å¤„ç†
    â”œâ”€â”€ preprocess_wales.py          # å¨å°”å£«æ•°æ®å¤„ç†
    â”œâ”€â”€ preprocess_uk.py             # è‹±å›½æ•°æ®å¤„ç†
    â”œâ”€â”€ preprocess_projections.py    # æŠ•å½±æ•°æ®å¤„ç†
    â”œâ”€â”€ merge_projection_data.py     # æ•°æ®èåˆ
    â”œâ”€â”€ model_prophet.py             # Prophet æ—¶é—´åºåˆ—æ¨¡å‹
    â”œâ”€â”€ model_arima.py               # ARIMA æ¨¡å‹ & å¤šæ¨¡å‹å¯¹æ¯”
    â”œâ”€â”€ arima_model.py               # ARIMA åŸºç¡€å‡½æ•°
    â”œâ”€â”€ plot_ageing.py               # è€é¾„åŒ–è¶‹åŠ¿å¯è§†åŒ–
    â”œâ”€â”€ plot_forecast_england.py     # è‹±æ ¼å…°é¢„æµ‹ç»“æœå¯è§†åŒ–
    â”œâ”€â”€ plot_comparison.py           # æ¨¡å‹å¯¹æ¯”å¯è§†åŒ–
    â”œâ”€â”€ forecast_export.py           # é¢„æµ‹ç»“æœå¯¼å‡º
    â”œâ”€â”€ generate_england_timeseries.py  # ç”Ÿæˆè‹±æ ¼å…°æ—¶é—´åºåˆ—
    â”œâ”€â”€ generate_cluster_input.py    # ç”Ÿæˆèšç±»è¾“å…¥æ•°æ®
    â”œâ”€â”€ cluster_analysis.py          # èšç±»åˆ†æ
    â””â”€â”€ multi_region_compare.py      # å¤šåœ°åŒº Prophet vs ARIMA å¯¹æ¯”
```

## ï¿½ æ•°æ®å¤„ç†æµç¨‹è¯¦è§£

æœ¬é¡¹ç›®é‡‡ç”¨ç³»ç»ŸåŒ–çš„ ETLï¼ˆExtract-Transform-Loadï¼‰æµç¨‹è¿›è¡Œæ•°æ®å¤„ç†ã€‚ä»¥ä¸‹è¯¦ç»†è¯´æ˜æ•´ä¸ªæ•°æ®å¤„ç†çš„å„ä¸ªç¯èŠ‚ï¼š

### 1. æ•°æ®é‡‡é›†ä¸æå–ï¼ˆExtractï¼‰

#### æºæ•°æ®è·å–
é¡¹ç›®ä½¿ç”¨æ¥è‡ªè‹±å›½å›½å®¶ç»Ÿè®¡å±€ï¼ˆONSï¼‰çš„å®˜æ–¹æ•°æ®ï¼ŒåŒ…æ‹¬ä¸¤ç±»æ•°æ®æºï¼š

| æ•°æ®ç±»å‹ | æ–‡ä»¶å | æè¿° |
|--------|--------|------|
| **å†å²äººå£æ•°æ®** | `mid_year_population_estimates_uk.xlsx` | è‹±å›½å„åœ°åŒº 1991-2018 å¹´çš„äººå£è§‚æµ‹æ•°æ®ï¼ŒæŒ‰å¹´é¾„å’Œæ€§åˆ«åˆ†ç»„ |
| **äººå£æŠ•å½±æ•°æ®** | `SNPP18dt2.xlsx` | è‹±å›½ 2018 å¹´å‘å¸ƒçš„å®˜æ–¹äººå£é¢„æµ‹æ•°æ®ï¼ˆ2018-2043ï¼‰ |
| **åœ°åŒºæŠ•å½±æ•°æ®** | `*vsumpop20.xls` ç³»åˆ— | å„åœ°åŒºè¯¦ç»†æŠ•å½±æ•°æ®ï¼ˆè‹±æ ¼å…°ã€è‹æ ¼å…°ã€å¨å°”å£«ã€è‹±å›½æ•´ä½“ï¼‰ |

#### æ•°æ®æå–æ–¹å¼
```python
# ä½¿ç”¨ openpyxl å’Œ pandas è¯»å– Excel/XLS æ–‡ä»¶
import pandas as pd

# ç¤ºä¾‹ï¼šè¯»å–å†å²äººå£æ•°æ®
df_history = pd.read_excel('data/raw/mid_year_population_estimates_uk.xlsx', sheet_name='Population')

# ç¤ºä¾‹ï¼šè¯»å–æŠ•å½±æ•°æ®
df_projection = pd.read_excel('data/raw/SNPP18dt2.xlsx', sheet_name='Projections')
```

### 2. æ•°æ®æ¸…æ´—ä¸è½¬æ¢ï¼ˆTransformï¼‰

#### æ­¥éª¤ 2.1ï¼šç¼ºå¤±å€¼å¤„ç†
```
åŸå§‹æ•°æ® â†’ è¯†åˆ«ç¼ºå¤±å€¼ â†’ åˆ†æç¼ºå¤±åŸå›  â†’ å¡«å……æˆ–åˆ é™¤
```
- æ£€æµ‹ `NaN` å€¼å’Œç©ºå­—ç¬¦ä¸²
- å¯¹äºå¹´ä»½è¿ç»­çš„äººå£æ•°æ®ï¼Œä½¿ç”¨å‰å‘å¡«å……æˆ–çº¿æ€§æ’å€¼
- å¯¹äºæŠ•å½±æ•°æ®çš„ç¼ºå¤±å€¼ï¼Œæ ¹æ®è¶‹åŠ¿è¿›è¡Œåˆç†å¡«å……
- è®°å½•æ¸…æ´—æ—¥å¿—ä¾¿äºåç»­å®¡è®¡

**ç¤ºä¾‹ä»£ç **ï¼š
```python
# æ£€æµ‹ç¼ºå¤±å€¼
missing_data = df.isnull().sum()
print(f"ç¼ºå¤±å€¼ç»Ÿè®¡ï¼š\n{missing_data}")

# å¡«å……ç¼ºå¤±å€¼
df_filled = df.fillna(method='ffill')  # å‰å‘å¡«å……
df_interpolated = df.interpolate(method='linear')  # çº¿æ€§æ’å€¼
```

#### æ­¥éª¤ 2.2ï¼šæ•°æ®ç±»å‹è½¬æ¢
- å°†å¹´ä»½å­—æ®µè½¬æ¢ä¸º `int64` ç±»å‹
- å°†äººå£æ•°æ®è½¬æ¢ä¸º `int64` æˆ– `float64`
- ç»Ÿä¸€åœ°åŒºåç§°çš„æ•°æ®ç±»å‹å’Œæ ¼å¼

**ç¤ºä¾‹ä»£ç **ï¼š
```python
df['Year'] = df['Year'].astype('int64')
df['Population'] = df['Population'].astype('int64')
df['Region'] = df['Region'].astype('str').str.strip()
```

#### æ­¥éª¤ 2.3ï¼šæ•°æ®å»é‡
- æ£€æµ‹å®Œå…¨é‡å¤çš„è¡Œ
- æ£€æµ‹åŸºäº(å¹´ä»½ã€åœ°åŒºã€å¹´é¾„æ®µ)çš„é‡å¤
- ä¿ç•™ç¬¬ä¸€æ¬¡å‡ºç°çš„è®°å½•æˆ–é€‰æ‹©æœ€å¯é çš„æ•°æ®æº

**ç¤ºä¾‹ä»£ç **ï¼š
```python
# åˆ é™¤å®Œå…¨é‡å¤è¡Œ
df_deduplicated = df.drop_duplicates()

# åŸºäºç‰¹å®šåˆ—çš„å»é‡
df_deduplicated = df.drop_duplicates(subset=['Year', 'Region', 'AgeGroup'])
```

#### æ­¥éª¤ 2.4ï¼šå¼‚å¸¸å€¼æ£€æµ‹ä¸å¤„ç†
- **ç»Ÿè®¡å¼‚å¸¸**ï¼šä½¿ç”¨ 3-sigma è§„åˆ™æ£€æµ‹äººå£æ•°æ®å¼‚å¸¸
- **é€»è¾‘å¼‚å¸¸**ï¼šæ£€æµ‹äººå£æ•°æ®ä¸­çš„ä¸åˆç†å€¼ï¼ˆå¦‚è´Ÿæ•°ã€è¶…å¤§å¢é•¿ï¼‰
- **ä¸€è‡´æ€§å¼‚å¸¸**ï¼šæ£€æµ‹åŒä¸€å¹´ä»½ä¸åŒåœ°åŒºæ•°æ®çš„ä¸ä¸€è‡´

**ç¤ºä¾‹ä»£ç **ï¼š
```python
# 3-sigma å¼‚å¸¸æ£€æµ‹
mean = df['Population'].mean()
std = df['Population'].std()
df['is_outlier'] = (df['Population'] - mean).abs() > 3 * std

# æ£€æµ‹è´Ÿæ•°æˆ–é›¶å€¼
invalid_records = df[df['Population'] <= 0]

# å¤„ç†å¼‚å¸¸å€¼
df_clean = df[~df['is_outlier']]
```

#### æ­¥éª¤ 2.5ï¼šæ ¼å¼æ ‡å‡†åŒ–
å°†åŸå§‹æ•°æ®è½¬æ¢ä¸º**é•¿æ ¼å¼ï¼ˆLong Formatï¼‰**ï¼Œä¾¿äºæ—¶é—´åºåˆ—åˆ†æå’Œå»ºæ¨¡ï¼š

**åŸå§‹æ ¼å¼ï¼ˆå®½æ ¼å¼ï¼‰**ï¼š
```
| Year | 0-4å² | 5-9å² | 10-14å² | ... |
|------|-------|-------|---------|-----|
| 2000 |       |       |         |     |
| 2001 |       |       |         |     |
```

**ç›®æ ‡æ ¼å¼ï¼ˆé•¿æ ¼å¼ï¼‰**ï¼š
```
| Year | Region  | AgeGroup | Population |
|------|---------|----------|------------|
| 2000 | England | 0-4      | 3,234,567  |
| 2000 | England | 5-9      | 3,345,678  |
| 2000 | Scotland| 0-4      | 234,567    |
```

**ç¤ºä¾‹ä»£ç **ï¼š
```python
import pandas as pd

# ä»å®½æ ¼å¼è½¬æ¢ä¸ºé•¿æ ¼å¼
df_long = df.melt(
    id_vars=['Year', 'Region'],
    value_vars=['0-4', '5-9', '10-14', ...],
    var_name='AgeGroup',
    value_name='Population'
)
```

### 3. åœ°åŒºæ•°æ®èåˆï¼ˆTransform - å¤šæºèåˆï¼‰

#### æ­¥éª¤ 3.1ï¼šå†å²æ•°æ®ä¸æŠ•å½±æ•°æ®åˆå¹¶
```
å†å²æ•°æ®ï¼ˆ1991-2018ï¼‰+ æŠ•å½±æ•°æ®ï¼ˆ2018-2070ï¼‰
                    â†“
              æ•°æ®å¯¹é½ä¸å»é‡
                    â†“
          å®Œæ•´æ—¶é—´åºåˆ—ï¼ˆ1991-2070ï¼‰
```

**åˆå¹¶é€»è¾‘**ï¼š
```python
# åˆå¹¶å†å²æ•°æ®å’ŒæŠ•å½±æ•°æ®
df_merged = pd.concat([df_history, df_projection], ignore_index=True)

# æŒ‰å¹´ä»½æ’åº
df_merged = df_merged.sort_values('Year').reset_index(drop=True)

# æ£€æµ‹å¹¶å¤„ç†é‡å éƒ¨åˆ†
overlap_period = df_merged[(df_merged['Year'] >= 2018) & (df_merged['Year'] <= 2020)]
```

#### æ­¥éª¤ 3.2ï¼šåœ°åŒºæ•°æ®ç»Ÿä¸€
- è‹±æ ¼å…°ã€è‹æ ¼å…°ã€å¨å°”å£«åˆ†åˆ«å¤„ç†åç»Ÿä¸€
- åˆ›å»º"è‹±å›½æ€»ä½“"æ•°æ®ï¼ˆèšåˆæ‰€æœ‰åœ°åŒºï¼‰
- ç»Ÿä¸€åœ°åŒºåç§°è¡¨ç¤ºæ³•

**ç¤ºä¾‹ä»£ç **ï¼š
```python
# æŒ‰åœ°åŒºè¿‡æ»¤
df_england = df[df['Region'] == 'England']
df_scotland = df[df['Region'] == 'Scotland']
df_wales = df[df['Region'] == 'Wales']

# åˆ›å»ºè‹±å›½æ•´ä½“æ•°æ®
df_uk = df.groupby('Year').agg({'Population': 'sum'}).reset_index()
df_uk['Region'] = 'UK'
```

### 4. ç‰¹å¾è®¡ç®—ä¸å·¥ç¨‹ï¼ˆTransform - ç‰¹å¾åˆ›å»ºï¼‰

#### æ­¥éª¤ 4.1ï¼šè®¡ç®—è€é¾„åŒ–æ¯”ä¾‹
```
65+ äººå£ = æ‰€æœ‰ â‰¥65 å²å¹´é¾„æ®µäººå£ä¹‹å’Œ
è€é¾„åŒ–æ¯”ä¾‹ = 65+ äººå£ / æ€»äººå£ * 100%
```

**ç¤ºä¾‹ä»£ç **ï¼š
```python
# å®šä¹‰è€é¾„åŒ–å¹´é¾„æ®µ
age_groups_65plus = ['65-69', '70-74', '75-79', '80-84', '85+']

# è®¡ç®— 65+ äººå£
df['population_65plus'] = df[df['AgeGroup'].isin(age_groups_65plus)]['Population'].sum()

# è®¡ç®—è€é¾„åŒ–æ¯”ä¾‹
df['ageing_ratio'] = (df['population_65plus'] / df['total_population']) * 100
```

#### æ­¥éª¤ 4.2ï¼šæ—¶é—´ç‰¹å¾æå–
ä¸ºæ¨¡å‹æä¾›æ—¶é—´åºåˆ—ç‰¹å¾ï¼š
```python
# åˆ›å»ºæ—¶é—´ç‰¹å¾
df['year_numeric'] = df['Year'] - df['Year'].min()  # ä» 0 å¼€å§‹çš„å¹´ä»½ç¼–ç 
df['year_scaled'] = df['year_numeric'] / df['year_numeric'].max()  # å½’ä¸€åŒ–å¹´ä»½
```

#### æ­¥éª¤ 4.3ï¼šè¶‹åŠ¿ç‰¹å¾è®¡ç®—
```python
# è®¡ç®—å˜åŒ–ç‡
df['population_change'] = df['Population'].diff()  # ç»å¯¹å˜åŒ–
df['population_pct_change'] = df['Population'].pct_change() * 100  # ç™¾åˆ†æ¯”å˜åŒ–

# è®¡ç®—æ»šåŠ¨å¹³å‡ï¼ˆå¹³æ»‘å™ªå£°ï¼‰
df['population_ma3'] = df['Population'].rolling(window=3).mean()
df['population_ma5'] = df['Population'].rolling(window=5).mean()
```

### 5. æ•°æ®éªŒè¯ä¸è´¨é‡è¯„ä¼°ï¼ˆQuality Assuranceï¼‰

#### æ­¥éª¤ 5.1ï¼šæ•°æ®å®Œæ•´æ€§æ£€æŸ¥
```python
# æ£€æŸ¥æ—¶é—´è·¨åº¦å®Œæ•´æ€§
years_range = range(df['Year'].min(), df['Year'].max() + 1)
missing_years = set(years_range) - set(df['Year'].unique())

# æ£€æŸ¥åœ°åŒºè¦†ç›–
regions_coverage = df.groupby('Region')['Year'].count()
print(f"å„åœ°åŒºæ•°æ®è¦†ç›–æƒ…å†µï¼š\n{regions_coverage}")

# æ£€æŸ¥å¹´é¾„æ®µè¦†ç›–
age_groups_coverage = df.groupby('AgeGroup').size()
```

#### æ­¥éª¤ 5.2ï¼šæ•°æ®ä¸€è‡´æ€§éªŒè¯
```python
# éªŒè¯éƒ¨åˆ†å’Œæ•´ä½“çš„ä¸€è‡´æ€§
df_parts = df[df['Region'].isin(['England', 'Scotland', 'Wales'])].groupby('Year')['Population'].sum()
df_total = df[df['Region'] == 'UK'].groupby('Year')['Population'].sum()

# æ¯”è¾ƒå·®å¼‚
inconsistencies = (df_parts - df_total).abs() > 1000
```

#### æ­¥éª¤ 5.3ï¼šç»Ÿè®¡éªŒè¯
```python
# åŸºæœ¬ç»Ÿè®¡æ£€æŸ¥
print(f"äººå£æ•°æ®ç»Ÿè®¡ï¼š")
print(df['Population'].describe())

# æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸çš„å¢é•¿æˆ–ä¸‹é™
yearly_change = df.groupby('Year')['Population'].sum().pct_change()
extreme_changes = yearly_change[yearly_change.abs() > 0.05]  # >5% çš„å˜åŒ–
```

### 6. æ•°æ®è¾“å‡ºä¸å­˜å‚¨ï¼ˆLoadï¼‰

#### æ­¥éª¤ 6.1ï¼šå¤„ç†ç»“æœå¯¼å‡º
æ¸…æ´—åçš„æ•°æ®å¯¼å‡ºä¸ºæ ‡å‡†åŒ– CSV æ ¼å¼ï¼š

```python
# å¯¼å‡ºæ¸…æ´—åçš„æ•°æ®
df_clean.to_csv('data/processed/cleaned_population_long.csv', index=False, encoding='utf-8')

# å¯¼å‡ºè€é¾„åŒ–æ¯”ä¾‹æ•°æ®
df_ageing.to_csv('data/processed/ageing_ratio_per_region.csv', index=False, encoding='utf-8')

# å¯¼å‡ºèåˆåçš„å®Œæ•´æ•°æ®é›†
df_merged_final.to_csv('data/processed/uk_population_projection_all.csv', index=False, encoding='utf-8')
```

#### æ­¥éª¤ 6.2ï¼šèšç±»åˆ†ææ•°æ®å‡†å¤‡
ä¸ºèšç±»ç®—æ³•å‡†å¤‡æ•°æ®ï¼š

```python
# æå–ç‰¹å¾
features = ['Year', 'AgeGroup', 'Population', 'Ageing_Ratio']
df_cluster_input = df[features].copy()

# æ ‡å‡†åŒ–ï¼ˆä½¿ä¸åŒé‡çº²çš„ç‰¹å¾å¯æ¯”ï¼‰
from sklearn.preprocessing import StandardScaler
scaler = StandardScaler()
df_cluster_input_scaled = scaler.fit_transform(df_cluster_input)

# å¯¼å‡ºèšç±»è¾“å…¥æ•°æ®
pd.DataFrame(df_cluster_input_scaled).to_csv('data/processed/ageing_cluster_input.csv', index=False)
```

### 7. æ•°æ®å¤„ç†æµç¨‹

**æ•°æ®å¤„ç†æµç¨‹æ¦‚è§ˆ**

```
æ­¥éª¤ 1: æ•°æ®é‡‡é›† (Extract)
â”œâ”€ ä» Excel/XLS è¯»å– ONS åŸå§‹æ•°æ®
â”œâ”€ æ¥æº: data/raw/
â””â”€ è¾“å‡º: åŸå§‹ DataFrame

æ­¥éª¤ 2: æ•°æ®æ¸…æ´— (Transform - Cleaning)
â”œâ”€ ç¼ºå¤±å€¼å¤„ç† (æ£€æµ‹ã€å¡«å……æˆ–åˆ é™¤)
â”œâ”€ æ•°æ®ç±»å‹è½¬æ¢ (å¹´ä»½ã€äººå£æ•°ç­‰)
â”œâ”€ å»é‡å¤„ç† (åŸºäºå¤šåˆ—ç»„åˆå»é‡)
â””â”€ å¼‚å¸¸å€¼æ£€æµ‹ (3-sigmaã€é€»è¾‘å¼‚å¸¸)

æ­¥éª¤ 3: æ•°æ®èåˆ (Transform - Fusion)
â”œâ”€ æ ¼å¼æ ‡å‡†åŒ– (å®½æ ¼å¼ â†’ é•¿æ ¼å¼)
â”œâ”€ å†å²+æŠ•å½±æ•°æ®åˆå¹¶ (1991-2070)
â”œâ”€ åœ°åŒºæ•°æ®ç»Ÿä¸€ (è‹±æ ¼å…°/å¨å°”å£«/è‹æ ¼å…°)
â””â”€ å¹´ä»½å¯¹é½ (ç¡®ä¿å®Œæ•´çš„æ—¶é—´åºåˆ—)

æ­¥éª¤ 4: ç‰¹å¾å·¥ç¨‹ (Feature Engineering)
â”œâ”€ è®¡ç®—è€é¾„åŒ–æ¯”ä¾‹ (65+ äººå£å æ¯”)
â”œâ”€ æ—¶é—´ç‰¹å¾æå– (å¹´ä»½ç¼–ç ã€å½’ä¸€åŒ–)
â”œâ”€ è¶‹åŠ¿ç‰¹å¾è®¡ç®— (å˜åŒ–ç‡ã€ç™¾åˆ†æ¯”å˜åŒ–)
â””â”€ æ»šåŠ¨å¹³å‡å¹³æ»‘ (3å¹´ã€5å¹´)

æ­¥éª¤ 5: æ•°æ®éªŒè¯ (Validate)
â”œâ”€ å®Œæ•´æ€§æ£€æŸ¥ (ç¼ºå¤±ç‡ã€è¦†ç›–ç‡)
â”œâ”€ ä¸€è‡´æ€§éªŒè¯ (éƒ¨åˆ†å’Œä¸æ•´ä½“å¯¹é½)
â””â”€ ç»Ÿè®¡éªŒè¯ (æ•°æ®åˆ†å¸ƒã€å¼‚å¸¸æ£€æµ‹)

æ­¥éª¤ 6: æ•°æ®å¯¼å‡º (Load)
â”œâ”€ è¾“å‡ºç›®å½•: data/processed/
â”œâ”€ æ¸…æ´—æ•°æ®: cleaned_population_long.csv
â”œâ”€ è€é¾„åŒ–æ¯”ä¾‹: ageing_ratio_per_region.csv
â”œâ”€ èåˆæ•°æ®: uk_population_projection_all.csv
â””â”€ èšç±»è¾“å…¥: ageing_cluster_input.csv

æ­¥éª¤ 7: ä¸‹æ¸¸åº”ç”¨
â”œâ”€ æ—¶é—´åºåˆ—é¢„æµ‹ (Prophet/ARIMA æ¨¡å‹)
â”œâ”€ èšç±»åˆ†æ (KMeans åœ°åŒºåˆ†ç±»)
â””â”€ ç»“æœå¯è§†åŒ– (å›¾è¡¨ç”Ÿæˆ)
```

### 8. æ•°æ®å¤„ç†è´¨é‡æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | éªŒè¯æ–¹å¼ |
|-------|------|---------------------|
| **ç¼ºå¤±ç‡** | < 1% | `df.isnull().sum() / len(df)` |
| **é‡å¤ç‡** | = 0% | `len(df) == len(df.drop_duplicates())` |
| **ç¦»ç¾¤ç‚¹ç‡** | < 2% | ä½¿ç”¨ IQR æˆ– 3-sigma æ£€æµ‹ |
| **æ•°æ®ä¸€è‡´æ€§** | â‰¥ 98% | éƒ¨åˆ†å’Œä¸æ•´ä½“çš„å·®å¼‚ |
| **æ—¶é—´è¦†ç›–ç‡** | = 100% | æ‰€æœ‰å¹´ä»½éƒ½æœ‰æ•°æ® |

### 9. ä»£ç å®ç°

å®Œæ•´çš„æ•°æ®å¤„ç†æµç¨‹åœ¨ä»¥ä¸‹æ–‡ä»¶ä¸­å®ç°ï¼š

| æ–‡ä»¶ | åŠŸèƒ½ |
|---------------------------|---------------------|
| `src/preprocess.py` | è‹±å›½æ•´ä½“æ•°æ®æ¸…æ´— |
| `src/preprocess_england.py` | è‹±æ ¼å…°æ•°æ®å¤„ç† |
| `src/preprocess_scotland.py` | è‹æ ¼å…°æ•°æ®å¤„ç† |
| `src/preprocess_wales.py` | å¨å°”å£«æ•°æ®å¤„ç† |
| `src/preprocess_projections.py` | æŠ•å½±æ•°æ®å¤„ç† |
| `src/merge_projection_data.py` | æ•°æ®èåˆä¸ç‰¹å¾è®¡ç®— |
| `main.py` | å®Œæ•´æµç¨‹ç¼–æ’ |

---

## ï¿½ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚
- Python 3.8+
- pip æˆ– conda

### å®‰è£…ä¾èµ–
```bash
pip install -r requirements.txt
```

### è¿è¡Œé¡¹ç›®

å®Œæ•´æµç¨‹ï¼ˆä»æ•°æ®é¢„å¤„ç†åˆ°æœ€ç»ˆé¢„æµ‹å’Œå¯è§†åŒ–ï¼‰ï¼š
```bash
python main.py
```

main.py åŒ…å«ä»¥ä¸‹ä¸»è¦æ­¥éª¤ï¼š
1. **æ•°æ®é¢„å¤„ç†** - æ¸…æ´— ONS åŸå§‹æ•°æ®
2. **è®¡ç®—è€é¾„åŒ–æ¯”ä¾‹** - æŒ‰åœ°åŒºè®¡ç®— 65+ äººå£å æ¯”
3. **Prophet é¢„æµ‹** - å„åœ°åŒºé•¿æœŸé¢„æµ‹
4. **ARIMA é¢„æµ‹** - å¯¹æ¯”åˆ†æ
5. **å¤šæ¨¡å‹è¯„ä¼°** - è®¡ç®— MAEã€RMSE ç­‰æŒ‡æ ‡
6. **èšç±»åˆ†æ** - åœ°åŒºè€é¾„åŒ–ç‰¹å¾åˆ†ç»„
7. **ç»“æœå¯è§†åŒ–** - ç”Ÿæˆå„ç±»å›¾è¡¨å’Œé¢„æµ‹æ•°æ®

## ï¿½ï¸ æŠ€æœ¯æ ˆ

### ç¼–ç¨‹è¯­è¨€ä¸å¹³å°
- **Python 3.8+** - æ ¸å¿ƒå¼€å‘è¯­è¨€
- **Jupyter Notebook** - äº¤äº’å¼æ•°æ®åˆ†æå’Œæ¢ç´¢

### æ•°æ®å¤„ç†ä¸åˆ†æ
| æŠ€æœ¯ | åŠŸèƒ½ |
|------|------|
| **Pandas** | æ•°æ®æ¡†æ¶ã€æ•°æ®æ¸…æ´—ã€æ—¶é—´åºåˆ—å¤„ç† |
| **NumPy** | å¤šç»´æ•°ç»„è¿ç®—ã€æ•°å€¼è®¡ç®— |
| **SciPy** | ç§‘å­¦è®¡ç®—ã€ç»Ÿè®¡åˆ†æ |

### æ—¶é—´åºåˆ—é¢„æµ‹
| æŠ€æœ¯ | åŠŸèƒ½ |
|------|------|
| **Prophet** (Facebook) | æ—¶é—´åºåˆ—åˆ†è§£ã€è¶‹åŠ¿é¢„æµ‹ã€å˜åŒ–ç‚¹æ£€æµ‹ |
| **ARIMA** (pmdarima) | è‡ªå›å½’ç»¼åˆç§»åŠ¨å¹³å‡æ¨¡å‹ã€è‡ªåŠ¨å‚æ•°ä¼˜åŒ– |
| **Statsmodels** | ç»Ÿè®¡æ¨¡å‹ã€å‡è®¾æ£€éªŒã€æ—¶é—´åºåˆ—è¯Šæ–­ |

### æœºå™¨å­¦ä¹ ä¸èšç±»
| æŠ€æœ¯ | åŠŸèƒ½ |
|------|------|
| **Scikit-learn** | KMeans èšç±»ã€æ•°æ®æ ‡å‡†åŒ–ã€æ¨¡å‹è¯„ä¼° |
| **æ ‡å‡†åŒ– (StandardScaler)** | æ•°æ®é¢„å¤„ç†ã€ç‰¹å¾å½’ä¸€åŒ– |

### æ•°æ®å¯è§†åŒ–
| æŠ€æœ¯ | åŠŸèƒ½ |
|------|------|
| **Matplotlib** | åŸºç¡€ç»˜å›¾ã€å›¾è¡¨ç”Ÿæˆ |
| **Pillow** | å›¾åƒå¤„ç† |

### æ€§èƒ½ä¼˜åŒ–
| æŠ€æœ¯ | åŠŸèƒ½ |
|------|------|
| **Cython** | C åŠ é€Ÿã€æ€§èƒ½ä¼˜åŒ– |
| **Joblib** | å¹¶è¡Œè®¡ç®—ã€ç¼“å­˜ç®¡ç† |
| **Threadpoolctl** | çº¿ç¨‹æ± æ§åˆ¶ |

### æ¨¡å‹æ¡†æ¶
- **CmdStanPy** - Stan æ¦‚ç‡ç¼–ç¨‹æ¡†æ¶ï¼ˆProphet å†…éƒ¨ä½¿ç”¨ï¼‰

### æ•°æ®è¾“å…¥æ ¼å¼
- **Excel** (.xlsx, .xls) - ONS åŸå§‹æ•°æ®
- **CSV** (.csv) - å¤„ç†åçš„æ•°æ®æ ¼å¼

## ï¿½ğŸ“Š ä¸»è¦ä¾èµ–

| åŒ…å | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| pandas | 2.2.2 | æ•°æ®å¤„ç†å’Œæ“ä½œ |
| numpy | 1.24.4 | æ•°å€¼è®¡ç®— |
| matplotlib | 3.7.5 | æ•°æ®å¯è§†åŒ– |
| prophet | 1.1.7 | Facebook Prophet æ—¶é—´åºåˆ—é¢„æµ‹ |
| statsmodels | 0.14.1 | ç»Ÿè®¡æ¨¡å‹å’Œæµ‹è¯• |
| pmdarima | 2.0.4 | ARIMA è‡ªåŠ¨å‚æ•°é€‰æ‹© |
| scikit-learn | 1.3.2 | æœºå™¨å­¦ä¹ ï¼ˆèšç±»ã€é¢„å¤„ç†ï¼‰ |
| scipy | 1.10.1 | ç§‘å­¦è®¡ç®— |
| cmdstanpy | 1.2.5 | Stan æ¦‚ç‡ç¼–ç¨‹æ¡†æ¶ |
| Cython | 3.1.2 | C åŠ é€Ÿç¼–è¯‘ |
| joblib | 1.5.1 | å¹¶è¡Œè®¡ç®— |
| holidays | 0.78 | å‡æœŸå¤„ç†ï¼ˆProphet ä½¿ç”¨ï¼‰ |
| pillow | 11.3.0 | å›¾åƒå¤„ç† |

## ğŸ“ˆ è¾“å‡ºç¤ºä¾‹

é¡¹ç›®ä¼šç”Ÿæˆä»¥ä¸‹ç»“æœï¼š

### å¯è§†åŒ–å›¾è¡¨
- `ageing_trend_65plus_fixed.png` - è‹±å›½ 65+ äººå£æ¯”ä¾‹å†å²è¶‹åŠ¿
- `prophet_65plus_england.png` - è‹±æ ¼å…° Prophet é¢„æµ‹ç»“æœ
- `prophet_65plus_all_regions.png` - å…¨éƒ¨åœ°åŒº Prophet é¢„æµ‹å¯¹æ¯”
- `compare_arima_prophet_england.png` - Prophet vs ARIMA å¯¹æ¯”
- `ageing_clusters.png` - åœ°åŒºèšç±»å¯è§†åŒ–
- `forecast_comparison_regions.png` - å¤šåœ°åŒºé¢„æµ‹å¯¹æ¯”

### æ•°æ®å¯¼å‡º
- `england_forecast.csv` - è‹±æ ¼å…°é¢„æµ‹æ•°æ®
- `england_timeseries.csv` - è‹±æ ¼å…°æ—¶é—´åºåˆ—æ•°æ®
- `multi_compare/prophet_arima_metrics.csv` - æ¨¡å‹è¯„ä¼°æŒ‡æ ‡

## ğŸ”§ é…ç½®å‚æ•°

åœ¨ `main.py` ä¸­å¯ä»¥è°ƒæ•´ä»¥ä¸‹å‚æ•°ï¼š

```python
CONFIG = {
    "regions": ["England", "Wales", "Scotland"],  # åˆ†æåœ°åŒº
    "end_year": 2070,                              # é¢„æµ‹ç»ˆç‚¹å¹´ä»½
    "test_year_start": 2030,                       # æµ‹è¯•é›†èµ·å§‹å¹´ä»½
    "horizon": 30,                                 # é¢„æµ‹æ—¶é—´è·¨åº¦ï¼ˆå¹´ï¼‰
    "n_clusters": 3,                               # èšç±»æ•°é‡
    "random_state": 42                             # éšæœºç§å­
}
```

## ğŸ“ æ¨¡å‹è¯´æ˜

### Prophet æ¨¡å‹
- ä½¿ç”¨åˆ†æ®µçº¿æ€§è¶‹åŠ¿ + å­£èŠ‚æ€§åˆ†è§£
- å¯é€‰é€»è¾‘å¢é•¿çº¦æŸï¼ˆé˜²æ­¢ä¸åˆ‡å®é™…çš„é«˜å¢é•¿ï¼‰
- è‡ªé€‚åº”å˜åŒ–ç‚¹æ£€æµ‹æ•æ‰è¶‹åŠ¿å˜åŒ–
- æ”¯æŒæ»šåŠ¨å¹³å‡å¹³æ»‘é¢„æµ‹ç»“æœ

### ARIMA æ¨¡å‹
- ä½¿ç”¨ pmdarima åº“è¿›è¡Œè‡ªåŠ¨å‚æ•°æœç´¢ (p,d,q)
- é€šè¿‡ AIC å‡†åˆ™é€‰æ‹©æœ€ä¼˜å‚æ•°
- é€‚åˆäºå¹³ç¨³æˆ–ä¸€é˜¶å·®åˆ†å¹³ç¨³çš„æ—¶é—´åºåˆ—

### èšç±»åˆ†æ
- å¯¹å„åœ°åŒºçš„è€é¾„åŒ–è¶‹åŠ¿è¿›è¡Œç‰¹å¾æå–
- ä½¿ç”¨ KMeans è¿›è¡Œæ— ç›‘ç£èšç±»
- æ ‡å‡†åŒ–å¤„ç†ç¡®ä¿å…¬å¹³å¯¹æ¯”

## ğŸ’¡ ä¸»è¦ç‰¹ç‚¹

âœ… **å¤šæºæ•°æ®æ•´åˆ** - èåˆ ONS å†å²æ•°æ®å’Œå®˜æ–¹æŠ•å½±æ•°æ®  
âœ… **å¤šæ¨¡å‹å¯¹æ¯”** - Prophetã€ARIMA ç­‰å¤šç§é¢„æµ‹æ–¹æ³•  
âœ… **åŒºåŸŸåˆ†æ** - æ”¯æŒè‹±å›½å„åœ°åŒºçš„ç‹¬ç«‹å’Œå¯¹æ¯”åˆ†æ  
âœ… **èšç±»è¯†åˆ«** - è‡ªåŠ¨è¯†åˆ«åŒºåŸŸè€é¾„åŒ–ç‰¹å¾ç›¸ä¼¼æ€§  
âœ… **å®Œæ•´æµç¨‹** - ä»æ•°æ®é¢„å¤„ç†åˆ°å¯è§†åŒ–çš„ç«¯åˆ°ç«¯å·¥ä½œæµ  
âœ… **å¯é‡ç°æ€§** - å›ºå®šéšæœºç§å­ç¡®ä¿ç»“æœå¯é‡ç°  

## ğŸ“§ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿æå‡º Issue æˆ– Pull Requestã€‚

## ğŸ“„ è®¸å¯è¯

æ­¤é¡¹ç›®ä»…ä¾›å­¦æœ¯å’Œç ”ç©¶ä½¿ç”¨ã€‚
